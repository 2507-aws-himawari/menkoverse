{
 "AWSTemplateFormatVersion": "2010-09-09",
 "Parameters": {
  "CallbackUrl": {
   "Type": "String",
   "Description": "Callback URL for OAuth",
   "Default": "http://localhost:3000/api/auth/callback/cognito"
  },
  "DomainPrefix": {
   "Type": "String",
   "Description": "Domain prefix for Cognito hosted UI",
   "Default": "menkoverse-dev",
   "AllowedPattern": "^[a-z0-9-]+$",
   "ConstraintDescription": "Must contain only lowercase letters, numbers, and hyphens"
  }
 },
 "Resources": {
  "UserPool": {
   "Type": "AWS::Cognito::UserPool",
   "Properties": {
    "UserPoolName": "MenkoverseUserPool",
    "AutoVerifiedAttributes": [
     "email"
    ],
    "UsernameAttributes": [
     "email"
    ],
    "VerificationMessageTemplate": {
     "DefaultEmailOption": "CONFIRM_WITH_CODE",
     "EmailMessage": "Your Menkoverse verification code is {####}",
     "EmailSubject": "Verify your Menkoverse account"
    },
    "EmailConfiguration": {
     "EmailSendingAccount": "COGNITO_DEFAULT"
    },
    "Policies": {
     "PasswordPolicy": {
      "MinimumLength": 8,
      "RequireUppercase": true,
      "RequireLowercase": true,
      "RequireNumbers": true,
      "RequireSymbols": false
     }
    }
   }
  },
  "UserPoolClient": {
   "Type": "AWS::Cognito::UserPoolClient",
   "Properties": {
    "ClientName": "MenkoverseUserPoolClient",
    "UserPoolId": {
     "Ref": "UserPool"
    },
    "GenerateSecret": true,
    "AllowedOAuthFlows": [
     "code"
    ],
    "AllowedOAuthScopes": [
     "email",
     "openid",
     "profile"
    ],
    "AllowedOAuthFlowsUserPoolClient": true,
    "CallbackURLs": [
     {
      "Ref": "CallbackUrl"
     },
     {
      "Fn::Sub": "https://${DomainPrefix}.auth.${AWS::Region}.amazoncognito.com/oauth2/idpresponse"
     }
    ],
    "SupportedIdentityProviders": [
     "COGNITO"
    ]
   }
  },
  "CognitoAuthenticatedRole": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "RoleName": "Cognito_MenkoverseAuth_Role",
    "AssumeRolePolicyDocument": {
     "Version": "2012-10-17",
     "Statement": [
      {
       "Effect": "Allow",
       "Principal": {
        "Federated": "cognito-identity.amazonaws.com"
       },
       "Action": "sts:AssumeRoleWithWebIdentity",
       "Condition": {
        "StringEquals": {
         "cognito-identity.amazonaws.com:aud": {
          "Ref": "IdentityPool"
         }
        },
        "ForAnyValue:StringLike": {
         "cognito-identity.amazonaws.com:amr": "authenticated"
        }
       }
      }
     ]
    },
    "Policies": [
     {
      "PolicyName": "CognitoAuthenticatedPolicy",
      "PolicyDocument": {
       "Version": "2012-10-17",
       "Statement": [
        {
         "Effect": "Allow",
         "Action": [
          "mobileanalytics:PutEvents",
          "cognito-sync:*",
          "cognito-identity:*"
         ],
         "Resource": "*"
        }
       ]
      }
     }
    ]
   }
  },
  "DummyParameter": {
   "Type": "AWS::SSM::Parameter",
   "Properties": {
    "Name": "/dummy/placeholder",
    "Value": "placeholder",
    "Type": "String"
   }
  },
  "UserPoolDomain": {
   "Type": "AWS::Cognito::UserPoolDomain",
   "Properties": {
    "Domain": {
     "Ref": "DomainPrefix"
    },
    "UserPoolId": {
     "Ref": "UserPool"
    }
   },
   "DependsOn": "UserPoolClient"
  },
  "IdentityPool": {
   "Type": "AWS::Cognito::IdentityPool",
   "Properties": {
    "IdentityPoolName": "MenkoverseIdentityPool",
    "AllowUnauthenticatedIdentities": false,
    "CognitoIdentityProviders": [
     {
      "ClientId": {
       "Ref": "UserPoolClient"
      },
      "ProviderName": {
       "Fn::GetAtt": [
        "UserPool",
        "ProviderName"
       ]
      }
     }
    ]
   }
  },
  "IdentityPoolRoleAttachment": {
   "Type": "AWS::Cognito::IdentityPoolRoleAttachment",
   "Properties": {
    "IdentityPoolId": {
     "Ref": "IdentityPool"
    },
    "Roles": {
     "authenticated": {
      "Fn::GetAtt": [
       "CognitoAuthenticatedRole",
       "Arn"
      ]
     }
    }
   }
  }
 },
 "Outputs": {
  "UserPoolId": {
   "Description": "Cognito User Pool ID",
   "Value": {
    "Ref": "UserPool"
   },
   "Export": {
    "Name": {
     "Fn::Sub": "${AWS::StackName}-UserPoolId"
    }
   }
  },
  "UserPoolClientId": {
   "Description": "Cognito User Pool Client ID",
   "Value": {
    "Ref": "UserPoolClient"
   },
   "Export": {
    "Name": {
     "Fn::Sub": "${AWS::StackName}-UserPoolClientId"
    }
   }
  },
  "IdentityPoolId": {
   "Description": "Cognito Identity Pool ID",
   "Value": {
    "Ref": "IdentityPool"
   },
   "Export": {
    "Name": {
     "Fn::Sub": "${AWS::StackName}-IdentityPoolId"
    }
   }
  },
  "CognitoIssuer": {
   "Description": "Cognito Issuer URL for auth.js",
   "Value": {
    "Fn::Sub": "https://cognito-idp.${AWS::Region}.amazonaws.com/${UserPool}"
   },
   "Export": {
    "Name": {
     "Fn::Sub": "${AWS::StackName}-CognitoIssuer"
    }
   }
  },
  "UserPoolDomain": {
   "Description": "Cognito User Pool Domain",
   "Value": {
    "Ref": "UserPoolDomain"
   },
   "Export": {
    "Name": {
     "Fn::Sub": "${AWS::StackName}-UserPoolDomain"
    }
   }
  },
  "HostedUIUrl": {
   "Description": "Cognito Hosted UI URL",
   "Value": {
    "Fn::Sub": "https://${DomainPrefix}.auth.${AWS::Region}.amazoncognito.com"
   },
   "Export": {
    "Name": {
     "Fn::Sub": "${AWS::StackName}-HostedUIUrl"
    }
   }
  }
 }
}